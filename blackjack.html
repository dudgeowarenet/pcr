<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blackjack â€” Pam's Casino</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800;900&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<style>
:root {
  --bg: #0a0900;
  --border: #2a2310;
  --accent: #FFD700;
  --accent2: #ff8c00;
  --text: #f0ead8;
  --muted: #7a6a40;
  --success: #4ade80;
  --error: #f87171;
  --red: #e63946;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh; display: flex; flex-direction: column;
  user-select: none; overflow-x: hidden;
}
body::before {
  content: ''; position: fixed; inset: 0;
  background: radial-gradient(ellipse 60% 40% at 50% 0%, rgba(255,215,0,0.05) 0%, transparent 55%),
    radial-gradient(ellipse 40% 60% at 90% 80%, rgba(255,60,0,0.03) 0%, transparent 50%);
  pointer-events: none; z-index: 0;
}

.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 24px; background: rgba(10,9,0,0.92);
  border-bottom: 1px solid var(--border); backdrop-filter: blur(8px);
  z-index: 10; flex-shrink: 0; position: sticky; top: 0;
}
.header-title { font-family: 'Syne', sans-serif; font-weight: 900; font-size: 1.2rem; letter-spacing: 0.15em; text-transform: uppercase; }
.header-title span { background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.back-btn {
  display: flex; align-items: center; gap: 8px;
  background: transparent; border: 1px solid var(--border);
  border-radius: 8px; padding: 7px 14px;
  color: var(--muted); font-family: 'DM Sans', sans-serif;
  font-size: 0.82rem; cursor: pointer; transition: all 0.2s;
  text-decoration: none;
}
.back-btn:hover { border-color: var(--accent); color: var(--accent); }
.pb-display { display: flex; align-items: center; gap: 8px; background: rgba(255,215,0,0.07); border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; padding: 7px 14px; }
.pb-label { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
.pb-val { font-family: 'Syne', sans-serif; font-weight: 800; color: var(--accent); font-size: 1rem; }
/* LOGIN PROMPT */
.login-prompt { position: absolute; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; background: rgba(10,9,0,0.88); backdrop-filter: blur(5px); }
.login-prompt.show { display: flex; }
.login-box { background: #12100a; border: 1px solid var(--border); border-radius: 16px; padding: 32px; text-align: center; max-width: 320px; }
.login-box h2 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.3rem; margin-bottom: 8px; }
.login-box p { color: var(--muted); font-size: 0.88rem; margin-bottom: 20px; line-height: 1.6; }
.login-link { display: inline-block; padding: 12px 28px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 10px; color: #000; font-family: 'Syne', sans-serif; font-weight: 800; font-size: 0.85rem; letter-spacing: 0.1em; text-transform: uppercase; text-decoration: none; transition: opacity 0.2s; }
.login-link:hover { opacity: 0.85; }

.game-wrap { display: flex; flex: 1; position: relative; z-index: 1; min-height: calc(100vh - 57px); }

/* SIDEBAR */
.sidebar { width: 230px; flex-shrink: 0; background: rgba(18,16,10,0.98); border-right: 1px solid var(--border); padding: 20px 16px; display: flex; flex-direction: column; gap: 14px; overflow-y: auto; }
.sb { background: rgba(255,215,0,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
.sbl { font-size: 0.68rem; font-family: 'Syne', sans-serif; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 10px; }
.bet-input { width: 100%; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.95rem; outline: none; transition: border-color 0.2s; margin-bottom: 8px; }
.bet-input:focus { border-color: var(--accent); }
.chip-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
.chip { flex: 1; min-width: 40px; padding: 7px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.72rem; cursor: pointer; transition: all 0.15s; text-align: center; }
.chip:hover { border-color: var(--accent); color: var(--accent); }
.adj-row { display: flex; gap: 6px; }
.adj-btn { flex: 1; padding: 8px 4px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.78rem; cursor: pointer; transition: all 0.15s; text-align: center; }
.adj-btn:hover { border-color: var(--accent); color: var(--accent); }

.shoe-wrap { display: flex; align-items: center; gap: 8px; }
.shoe-bar { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.shoe-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 3px; transition: width 0.4s; }
.shoe-label { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--muted); white-space: nowrap; }

.mini-stats { display: flex; gap: 6px; }
.mini-stat { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px 6px; text-align: center; }
.msla { font-size: 0.62rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
.msvl { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 0.9rem; margin-top: 2px; }

.h-dots { display: flex; flex-wrap: wrap; gap: 4px; min-height: 28px; }
.h-dot { width: 22px; height: 22px; border-radius: 50%; font-size: 0.6rem; font-weight: 700; display: flex; align-items: center; justify-content: center; font-family: 'DM Mono', monospace; }
.h-dot.w { background: rgba(74,222,128,0.18); color: var(--success); border: 1px solid rgba(74,222,128,0.3); }
.h-dot.l { background: rgba(248,113,113,0.18); color: var(--error); border: 1px solid rgba(248,113,113,0.3); }
.h-dot.p { background: rgba(255,215,0,0.1); color: var(--accent); border: 1px solid rgba(255,215,0,0.3); }
.h-rate { font-size: 0.72rem; color: var(--muted); margin-top: 6px; font-family: 'DM Mono', monospace; }

.rules-list { list-style: none; }
.rules-list li { font-size: 0.72rem; color: var(--muted); padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.03); display: flex; align-items: center; gap: 6px; }
.rules-list li::before { content: 'â—†'; color: var(--accent); font-size: 0.5rem; }

/* FELT */
.felt-area {
  flex: 1;
  background: radial-gradient(ellipse 70% 60% at 50% 50%, #0f3520 0%, #0a2216 50%, #061610 100%);
  display: flex; flex-direction: column; align-items: center; justify-content: space-between;
  padding: 28px 20px 20px; position: relative; overflow: hidden;
}
.felt-area::before {
  content: ''; position: absolute; inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(255,255,255,0.007) 40px, rgba(255,255,255,0.007) 41px),
    repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(255,255,255,0.007) 40px, rgba(255,255,255,0.007) 41px);
  pointer-events: none;
}

.zone { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
.zone-lbl { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.7rem; letter-spacing: 0.2em; text-transform: uppercase; color: rgba(255,215,0,0.35); }

.hands-wrap { display: flex; gap: 24px; align-items: flex-start; justify-content: center; flex-wrap: wrap; }
.hand-blk { display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative; padding: 6px; border-radius: 12px; border: 1px solid transparent; transition: border-color 0.2s; }
.hand-blk.active { border-color: rgba(255,215,0,0.28); }
.hand-lbl { font-size: 0.65rem; color: var(--muted); font-family: 'Syne', sans-serif; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; }
.hand-bet { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--accent); background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.2); border-radius: 10px; padding: 2px 8px; }

.score-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 36px; height: 28px; padding: 0 10px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,215,0,0.2); border-radius: 20px; font-family: 'Syne', sans-serif; font-weight: 800; font-size: 0.9rem; color: var(--text); transition: all 0.3s; }
.score-badge.bust { border-color: var(--error); color: var(--error); }
.score-badge.bj { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 12px rgba(255,215,0,0.3); }

.card-row { display: flex; align-items: flex-start; min-height: 108px; }

/* CARDS */
.card {
  width: 70px; height: 100px;
  background: #faf8f2; border-radius: 7px;
  border: 1.5px solid #d4c9a8;
  box-shadow: 2px 3px 10px rgba(0,0,0,0.65), inset 0 0 0 1px rgba(255,255,255,0.55);
  display: flex; flex-direction: column; justify-content: space-between;
  padding: 4px; position: relative; flex-shrink: 0;
  margin-left: -16px; transition: transform 0.15s; cursor: default;
}
.card:first-child { margin-left: 0; }
.card:hover { transform: translateY(-5px); z-index: 5; }
.card.red { color: #e63946; }
.card.black { color: #1a1a2e; }

.cc { display: flex; flex-direction: column; align-items: center; line-height: 1; }
.cr { font-family: 'Syne', sans-serif; font-weight: 900; font-size: 0.9rem; }
.cs { font-size: 0.65rem; }
.cc.bot { transform: rotate(180deg); }
.ccs { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 1.5rem; line-height: 1; pointer-events: none; }

/* Face down */
.card.fd {
  background: repeating-linear-gradient(45deg, #1a3a2a, #1a3a2a 4px, #0f2518 4px, #0f2518 8px);
  border-color: #2a5a3a;
}
.card.fd .cc, .card.fd .ccs { visibility: hidden; }
.card.fd::after { content: ''; position: absolute; inset: 4px; border: 1px solid rgba(255,255,255,0.06); border-radius: 4px; }

@keyframes dealIn {
  from { opacity: 0; transform: translateY(-45px) scale(0.8) rotate(-6deg); }
  to   { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
}
.card.ani { animation: dealIn 0.22s cubic-bezier(0.34,1.56,0.64,1) forwards; }

@keyframes flipCard {
  0%   { transform: scaleX(1); }
  50%  { transform: scaleX(0); }
  100% { transform: scaleX(1); }
}
.card.flp { animation: flipCard 0.3s ease-in-out forwards; }

/* CENTER */
.center-zone { display: flex; flex-direction: column; align-items: center; gap: 8px; min-height: 72px; justify-content: center; position: relative; z-index: 2; }
.result-banner { font-family: 'Syne', sans-serif; font-weight: 900; font-size: 2rem; letter-spacing: 0.08em; text-transform: uppercase; opacity: 0; transform: scale(0.6); transition: all 0.35s cubic-bezier(0.34,1.56,0.64,1); text-shadow: 0 0 30px currentColor; }
.result-banner.show { opacity: 1; transform: scale(1); }
.result-banner.win  { color: var(--success); }
.result-banner.bj   { color: var(--accent); }
.result-banner.lose { color: var(--error); }
.result-banner.push { color: var(--muted); }
.payout-text { font-family: 'DM Mono', monospace; font-size: 0.95rem; color: var(--muted); opacity: 0; transition: opacity 0.3s 0.15s; }
.payout-text.show { opacity: 1; }
.payout-text.plus { color: var(--success); }
.payout-text.minus { color: var(--error); }

/* ACTIONS */
.action-bar { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; width: 100%; }
.action-btn { padding: 12px 24px; border-radius: 10px; font-family: 'Syne', sans-serif; font-weight: 800; font-size: 0.82rem; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; transition: all 0.15s; border: none; outline: none; }
.btn-deal { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #0a0900; box-shadow: 0 4px 20px rgba(255,215,0,0.25); padding: 12px 40px; }
.btn-deal:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(255,215,0,0.4); }
.btn-hit    { background: rgba(255,215,0,0.1);  border: 1px solid rgba(255,215,0,0.3);  color: var(--accent); }
.btn-stand  { background: rgba(255,140,0,0.1);  border: 1px solid rgba(255,140,0,0.3);  color: var(--accent2); }
.btn-double { background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.3); color: var(--success); }
.btn-split  { background: rgba(99,179,237,0.1); border: 1px solid rgba(99,179,237,0.3); color: #63b3ed; }
.btn-hit:hover:not(:disabled)    { background: rgba(255,215,0,0.18); }
.btn-stand:hover:not(:disabled)  { background: rgba(255,140,0,0.18); }
.btn-double:hover:not(:disabled) { background: rgba(74,222,128,0.18); }
.btn-split:hover:not(:disabled)  { background: rgba(99,179,237,0.18); }
.action-btn:disabled { opacity: 0.3; cursor: not-allowed; }

/* INSURANCE */
.ins-overlay { display: none; position: absolute; inset: 0; z-index: 30; align-items: center; justify-content: center; background: rgba(0,0,0,0.55); backdrop-filter: blur(3px); }
.ins-overlay.show { display: flex; }
.ins-box { background: #12100a; border: 1px solid rgba(255,215,0,0.35); border-radius: 14px; padding: 22px 30px; text-align: center; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 16px 48px rgba(0,0,0,0.9); }
.ins-box h3 { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 900; letter-spacing: 0.12em; color: var(--accent); }
.ins-box p { font-size: 0.8rem; color: var(--muted); }
.ins-btns { display: flex; gap: 10px; justify-content: center; }
.ins-btn { padding: 9px 22px; border-radius: 9px; font-family: 'Syne', sans-serif; font-weight: 800; font-size: 0.8rem; letter-spacing: 0.08em; cursor: pointer; border: none; }
.ins-yes { background: rgba(255,215,0,0.15); border: 1px solid rgba(255,215,0,0.4); color: var(--accent); }
.ins-yes:hover { background: rgba(255,215,0,0.25); }
.ins-no  { background: rgba(248,113,113,0.1); border: 1px solid rgba(248,113,113,0.35); color: var(--error); }
.ins-no:hover  { background: rgba(248,113,113,0.18); }

.toast { position: fixed; top: 70px; left: 50%; transform: translateX(-50%) translateY(-10px); background: rgba(18,16,10,0.96); border: 1px solid var(--border); border-radius: 10px; padding: 10px 20px; font-family: 'Syne', sans-serif; font-size: 0.85rem; font-weight: 700; letter-spacing: 0.1em; opacity: 0; transition: all 0.25s; z-index: 100; pointer-events: none; white-space: nowrap; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.win  { border-color: rgba(74,222,128,0.4); color: var(--success); }
.toast.lose { border-color: rgba(248,113,113,0.4); color: var(--error); }
.toast.push { border-color: rgba(255,215,0,0.3); color: var(--accent); }

.shoe-deck { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column-reverse; gap: 1px; opacity: 0.4; }
.shoe-layer { width: 42px; height: 4px; background: linear-gradient(90deg, #2a5a3a, #1a4a2a); border-radius: 2px; border: 0.5px solid rgba(255,255,255,0.07); }
</style>
</head>
<body>

<header class="header">
  <a class="back-btn" href="index.html">â† Back</a>
  <div class="header-title">ğŸƒ <span>Blackjack</span></div>
  <div class="pb-display"><span class="pb-label">ğŸ’°</span><span class="pb-val" id="pbDisplay">â€”</span></div>
</header>

<div class="game-wrap">
  <div class="sidebar">
    <div class="sb">
      <div class="sbl">Bet Amount</div>
      <input type="number" class="bet-input" id="betInput" value="100" min="1">
      <div class="chip-row">
        <button class="chip" onclick="addToBet(5)">+5</button>
        <button class="chip" onclick="addToBet(25)">+25</button>
        <button class="chip" onclick="addToBet(100)">+100</button>
        <button class="chip" onclick="addToBet(500)">+500</button>
      </div>
      <div class="adj-row">
        <button class="adj-btn" onclick="adjBet(0.5)">Â½</button>
        <button class="adj-btn" onclick="adjBet(2)">2Ã—</button>
        <button class="adj-btn" onclick="maxBet()">Max</button>
      </div>
    </div>
    <div class="sb">
      <div class="sbl">6-Deck Shoe</div>
      <div class="shoe-wrap">
        <div class="shoe-bar"><div class="shoe-fill" id="shoeFill"></div></div>
        <div class="shoe-label" id="shoeLabel">312 left</div>
      </div>
    </div>
    <div class="sb">
      <div class="sbl">Session</div>
      <div class="mini-stats">
        <div class="mini-stat"><div class="msla">Hands</div><div class="msvl" id="stH">0</div></div>
        <div class="mini-stat"><div class="msla">Wins</div><div class="msvl" id="stW" style="color:var(--success)">0</div></div>
        <div class="mini-stat"><div class="msla">P&L</div><div class="msvl" id="stP">0</div></div>
      </div>
    </div>
    <div class="sb">
      <div class="sbl">History</div>
      <div class="h-dots" id="histDots"></div>
      <div class="h-rate" id="histRate">â€”</div>
    </div>
    <div class="sb">
      <div class="sbl">Rules</div>
      <ul class="rules-list">
        <li>6-deck shoe</li>
        <li>Blackjack pays 3:2</li>
        <li>Dealer hits soft 17</li>
        <li>Double on any 2 cards</li>
        <li>Double after split âœ“</li>
        <li>Resplit up to 4 hands</li>
        <li>No resplit aces</li>
        <li>Insurance offered</li>
      </ul>
    </div>
  </div>

  <div class="felt-area" id="feltArea">
    <div class="shoe-deck" id="shoeDeck"></div>

    <div class="zone">
      <div class="zone-lbl">Dealer</div>
      <div class="hands-wrap">
        <div class="hand-blk">
          <div class="card-row" id="dealerRow"></div>
          <div class="score-badge" id="dealerScore">â€”</div>
        </div>
      </div>
    </div>

    <div class="center-zone">
      <div class="result-banner" id="resultBanner"></div>
      <div class="payout-text" id="payoutText"></div>
    </div>

    <div class="zone">
      <div class="hands-wrap" id="handsWrap"></div>
      <div class="zone-lbl">Player</div>
    </div>

    <div class="action-bar">
      <button class="action-btn btn-deal"   id="btnDeal"   onclick="startHand()">Deal</button>
      <button class="action-btn btn-hit"    id="btnHit"    onclick="doHit()"    disabled>Hit</button>
      <button class="action-btn btn-stand"  id="btnStand"  onclick="doStand()"  disabled>Stand</button>
      <button class="action-btn btn-double" id="btnDouble" onclick="doDouble()" disabled>Double</button>
      <button class="action-btn btn-split"  id="btnSplit"  onclick="doSplit()"  disabled>Split</button>
    </div>

    <div class="ins-overlay" id="insOverlay">
      <div class="ins-box">
        <h3>Insurance?</h3>
        <p>Dealer shows Ace â€” side bet pays 2:1</p>
        <p id="insCost" style="color:var(--accent);font-family:'DM Mono',monospace;font-size:0.85rem;"></p>
        <div class="ins-btns">
          <button class="ins-btn ins-yes" onclick="takeIns(true)">Yes</button>
          <button class="ins-btn ins-no"  onclick="takeIns(false)">No</button>
        </div>
      </div>
    </div>

    <!-- LOGIN PROMPT -->
    <div class="login-prompt" id="loginPrompt">
      <div class="login-box">
        <h2>Sign in to play</h2>
        <p>You need a Pam's Casino account to play Blackjack and track your Pam Bucks.</p>
        <a class="login-link" href="index.html">Go to Login â†’</a>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
// â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AC = new (window.AudioContext || window.webkitAudioContext)();
const resume = () => AC.state === 'suspended' && AC.resume();

function mkNoise(dur, freq, Q, vol, delay=0) {
  const sz = AC.sampleRate*dur, buf = AC.createBuffer(1,sz,AC.sampleRate), d=buf.getChannelData(0);
  for(let i=0;i<sz;i++) d[i]=Math.random()*2-1;
  const src=AC.createBufferSource(); src.buffer=buf;
  const flt=AC.createBiquadFilter(); flt.type='bandpass'; flt.frequency.value=freq; flt.Q.value=Q;
  const g=AC.createGain(), t=AC.currentTime+delay;
  g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(0.001,t+dur);
  src.connect(flt); flt.connect(g); g.connect(AC.destination); src.start(t); src.stop(t+dur);
}
function mkTone(freq,type,dur,vol,delay=0,endFreq=null) {
  const o=AC.createOscillator(), g=AC.createGain(), t=AC.currentTime+delay;
  o.type=type; o.frequency.setValueAtTime(freq,t);
  if(endFreq) o.frequency.exponentialRampToValueAtTime(endFreq,t+dur);
  g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(0.001,t+dur);
  o.connect(g); g.connect(AC.destination); o.start(t); o.stop(t+dur);
}

const sndDeal   = () => { resume(); mkNoise(0.05, 2400+Math.random()*300, 2, 0.12); };
const sndFlip   = () => { resume(); mkNoise(0.08,1800,1,0.13); mkTone(220,'sine',0.06,0.07,0.04); };
const sndChip   = () => { resume(); mkTone(1200,'sine',0.08,0.1,0,800); };
const sndBust   = () => { resume(); mkNoise(0.15,160,1,0.45); mkTone(180,'sawtooth',0.45,0.08,0.05,55); };
const sndWin    = () => {
  resume();
  [523,659,784,1047].forEach((f,i) => {
    const o=AC.createOscillator(),g=AC.createGain(),t=AC.currentTime+i*0.08;
    o.type='triangle'; o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.12,t+0.01); g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
    o.connect(g); g.connect(AC.destination); o.start(t); o.stop(t+0.3);
  });
};
const sndBJ = () => {
  resume();
  [523,659,784,880,1047,1318].forEach((f,i) => {
    const o=AC.createOscillator(),g=AC.createGain(),t=AC.currentTime+i*0.07;
    o.type='triangle'; o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.14,t+0.01); g.gain.exponentialRampToValueAtTime(0.001,t+0.4);
    o.connect(g); g.connect(AC.destination); o.start(t); o.stop(t+0.4);
  });
};

// â”€â”€ SHOE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const SUITS=['â™ ','â™¥','â™¦','â™£'];
const REDS=new Set(['â™¥','â™¦']);
let shoe=[], shoeTotal=312;

function buildShoe() {
  shoe=[];
  for(let d=0;d<6;d++) for(const s of SUITS) for(const r of RANKS) shoe.push({r,s});
  for(let i=shoe.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [shoe[i],shoe[j]]=[shoe[j],shoe[i]]; }
  shoeTotal=shoe.length; updateShoeUI(); buildShoeDeck();
}
function draw() {
  if(shoe.length<52){ buildShoe(); toast('Shoe reshuffled','push'); }
  const c=shoe.pop(); updateShoeUI(); return c;
}
function updateShoeUI() {
  document.getElementById('shoeFill').style.width=(shoe.length/shoeTotal*100)+'%';
  document.getElementById('shoeLabel').textContent=shoe.length+' left';
}
function buildShoeDeck() {
  const el=document.getElementById('shoeDeck'); el.innerHTML='';
  for(let i=0;i<Math.min(22,Math.ceil(shoe.length/14));i++){const d=document.createElement('div');d.className='shoe-layer';el.appendChild(d);}
}

// â”€â”€ MATH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cv = r => ['J','Q','K'].includes(r)?10:r==='A'?11:+r;
function total(cards) {
  let t=0,a=0;
  for(const c of cards){ t+=cv(c.r); if(c.r==='A')a++; }
  while(t>21&&a--) t-=10;
  return t;
}
function isSoft(cards){ let t=0,a=0; for(const c of cards){t+=cv(c.r);if(c.r==='A')a++;} return a>0&&t<=21; }
const isSoft17 = cards => total(cards)===17&&isSoft(cards);
const isBJ     = cards => cards.length===2&&total(cards)===21;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let bal=10000, hands=[], aidx=0, dealer=[], phase='bet', ins=0;
let sH=0, sW=0, sPnl=0, hist=[];
let currentUser = null;
let userPB = 10000;

// â”€â”€ CARD ELEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkCard(card, faceDown, animate) {
  const el=document.createElement('div');
  el.className='card'+(faceDown?' fd':(REDS.has(card.s)?' red':' black'))+(animate?' ani':'');
  el.innerHTML=faceDown?'':`
    <div class="cc top"><div class="cr">${card.r}</div><div class="cs">${card.s}</div></div>
    <div class="ccs">${card.s}</div>
    <div class="cc bot"><div class="cr">${card.r}</div><div class="cs">${card.s}</div></div>`;
  return el;
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getHand(i){ return document.getElementById('handsWrap').querySelectorAll('.hand-blk')[i]; }
function getHandRow(i){ const h=getHand(i); return h?h.querySelector('.card-row'):null; }
function getHandScore(i){ const h=getHand(i); return h?h.querySelector('.score-badge'):null; }
function getHandBet(i){ const h=getHand(i); return h?h.querySelector('.hand-bet'):null; }

function setScore(el, hand, fromSplit) {
  if(!el||!hand.cards.length){if(el)el.textContent='â€”';return;}
  const t=total(hand.cards);
  const bj=isBJ(hand.cards)&&!fromSplit;
  el.textContent=t>21?`${t} BUST`:bj?'21 BJ':t;
  el.className='score-badge'+(t>21?' bust':bj?' bj':'');
}

function setDealerScore(hideHole) {
  const el=document.getElementById('dealerScore');
  if(!dealer.length){el.textContent='â€”';el.className='score-badge';return;}
  if(hideHole){
    const v=cv(dealer[0].r);
    el.textContent=v===11?'11':v; el.className='score-badge';
  } else {
    const t=total(dealer);
    el.textContent=t>21?`${t} BUST`:isBJ(dealer)?'21 BJ':t;
    el.className='score-badge'+(t>21?' bust':isBJ(dealer)?' bj':'');
  }
}

// Build hand DOM block
function makeHandBlock(idx, isActive) {
  const blk=document.createElement('div');
  blk.className='hand-blk'+(isActive?' active':'');
  if(hands.length>1){const l=document.createElement('div');l.className='hand-lbl';l.textContent=`Hand ${idx+1}`;blk.appendChild(l);}
  const row=document.createElement('div'); row.className='card-row'; blk.appendChild(row);
  const sc=document.createElement('div'); sc.className='score-badge'; sc.textContent='â€”'; blk.appendChild(sc);
  const bb=document.createElement('div'); bb.className='hand-bet';
  bb.textContent=hands[idx].bet.toLocaleString()+' PB'; blk.appendChild(bb);
  return blk;
}

// Full re-render of hands (rebuilds DOM, adds cards without animation)
function renderHands() {
  const wrap=document.getElementById('handsWrap'); wrap.innerHTML='';
  hands.forEach((hand,i)=>{
    const blk=makeHandBlock(i, i===aidx&&phase==='play');
    const row=blk.querySelector('.card-row');
    hand.cards.forEach(c=>row.appendChild(mkCard(c,false,false)));
    setScore(blk.querySelector('.score-badge'), hand, hand.fromSplit);
    const bb=blk.querySelector('.hand-bet');
    if(bb) bb.textContent=hand.bet.toLocaleString()+' PB'+(hand.doubled?' (2Ã—)':'');
    wrap.appendChild(blk);
  });
}

// Render dealer (no animation)
function renderDealer(hideHole) {
  const row=document.getElementById('dealerRow'); row.innerHTML='';
  dealer.forEach((c,i)=>row.appendChild(mkCard(c,hideHole&&i===1,false)));
  setDealerScore(hideHole);
}

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startHand() {
  if (!currentUser) return;
  resume();
  const bet=getBet();
  if(bet>bal){toast('Insufficient balance','lose');return;}
  if(bet<1) return;

  document.getElementById('resultBanner').className='result-banner';
  document.getElementById('payoutText').className='payout-text';
  setBtns('none');

  bal-=bet; updateBal();
  // Persist deduction immediately â€” so reload can't cancel the bet
  db.from('users').update({ pam_bucks: bal }).eq('id', currentUser.id);
  // Mark game in progress â€” if they reload now, init() will see this and keep the loss
  localStorage.setItem('bj_pending_' + currentUser.id, bal.toString());
  hands=[{cards:[],bet,done:false,doubled:false,fromSplit:false}];
  dealer=[]; aidx=0; ins=0; phase='play';

  // Clear display
  document.getElementById('dealerRow').innerHTML='';
  document.getElementById('dealerScore').textContent='â€”';
  document.getElementById('dealerScore').className='score-badge';
  // Build initial hand block with empty card row
  const wrap=document.getElementById('handsWrap'); wrap.innerHTML='';
  wrap.appendChild(makeHandBlock(0,true));

  // Deal: P1, D1, P2, D2(hole)
  await dealToPlayer(0);
  await wait(180);
  await dealToDealer(false);
  await wait(180);
  await dealToPlayer(0);
  await wait(180);
  await dealToDealer(true);
  await wait(100);

  if(dealer[0].r==='A'){
    phase='ins';
    document.getElementById('insCost').textContent=`Cost: ${Math.floor(bet/2).toLocaleString()} PB`;
    document.getElementById('insOverlay').classList.add('show');
    return;
  }
  await afterDeal();
}

async function dealToPlayer(idx) {
  const card=draw();
  hands[idx].cards.push(card);
  sndDeal();
  const row=getHandRow(idx);
  if(row){ const el=mkCard(card,false,true); row.appendChild(el); }
  setScore(getHandScore(idx), hands[idx], hands[idx].fromSplit);
  await wait(130);
}

async function dealToDealer(faceDown) {
  const card=draw();
  dealer.push(card);
  sndDeal();
  const row=document.getElementById('dealerRow');
  row.appendChild(mkCard(card,faceDown,true));
  setDealerScore(faceDown||dealer.length<2?faceDown:false);
  // Keep hole card hidden correctly
  if(dealer.length===2) setDealerScore(true);
  await wait(130);
}

async function hitPlayer(idx) {
  const card=draw();
  hands[idx].cards.push(card);
  sndDeal();
  const row=getHandRow(idx);
  if(row){ const el=mkCard(card,false,true); row.appendChild(el); }
  setScore(getHandScore(idx), hands[idx], hands[idx].fromSplit);
  await wait(140);
}

async function hitDealer() {
  const card=draw();
  dealer.push(card);
  sndDeal();
  const row=document.getElementById('dealerRow');
  row.appendChild(mkCard(card,false,true));
  setDealerScore(false);
  await wait(200);
}

// â”€â”€ AFTER DEAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function afterDeal() {
  phase='play';
  const pBJ=isBJ(hands[0].cards), dBJ=isBJ(dealer);
  if(pBJ||dBJ){
    flipHole(); await wait(380);
    if(pBJ&&dBJ){ bal+=hands[0].bet; updateBal(); showResult('PUSH','push'); addHist('p',0); }
    else if(pBJ){ const pay=Math.floor(hands[0].bet*1.5); bal+=hands[0].bet+pay; updateBal(); sndBJ(); showResult('BLACKJACK!','bj'); addHist('w',pay); sW++; }
    else { sndBust(); showResult('DEALER BJ','lose'); addHist('l',-hands[0].bet); }
    phase='done'; sH++; updateStats(); setBtns('bet'); syncPB(); return;
  }
  setBtns('play'); refreshBtns();
}

// â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doHit() {
  if(phase!=='play') return; resume(); setBtns('none');
  await hitPlayer(aidx);
  const t=total(hands[aidx].cards);
  if(t>21){ sndBust(); hands[aidx].done=true; await nextHand(); }
  else if(t===21){ hands[aidx].done=true; await nextHand(); }
  else { setBtns('play'); document.getElementById('btnDouble').disabled=true; document.getElementById('btnSplit').disabled=true; }
}

async function doStand() {
  if(phase!=='play') return; resume(); hands[aidx].done=true; setBtns('none'); await nextHand();
}

async function doDouble() {
  if(phase!=='play') return; resume();
  const hand=hands[aidx];
  if(hand.bet>bal){ toast('Not enough to double','lose'); return; }
  setBtns('none');
  bal-=hand.bet; hand.bet*=2; hand.doubled=true; updateBal(); sndChip();
  // Persist double-down immediately and update pending marker
  db.from('users').update({ pam_bucks: bal }).eq('id', currentUser.id);
  if (currentUser) localStorage.setItem('bj_pending_' + currentUser.id, bal.toString());
  // Update bet display
  const bb=getHand(aidx)?.querySelector('.hand-bet');
  if(bb) bb.textContent=hand.bet.toLocaleString()+' PB (2Ã—)';
  await hitPlayer(aidx);
  hand.done=true;
  if(total(hand.cards)>21) sndBust();
  await nextHand();
}

async function doSplit() {
  if(phase!=='play') return; resume();
  const hand=hands[aidx];
  if(hands.length>=4){ toast('Max 4 hands','lose'); return; }
  if(hand.bet>bal){ toast('Not enough to split','lose'); return; }
  bal-=hand.bet; updateBal(); sndChip();
  // Persist split immediately and update pending marker
  db.from('users').update({ pam_bucks: bal }).eq('id', currentUser.id);
  if (currentUser) localStorage.setItem('bj_pending_' + currentUser.id, bal.toString());
  const splitCard=hand.cards.pop();
  const newHand={cards:[splitCard],bet:hand.bet,done:false,doubled:false,fromSplit:true};
  hand.fromSplit=true;
  hands.splice(aidx+1,0,newHand);

  // Rebuild all hand DOM blocks cleanly
  renderHands();

  // Deal one card to current hand
  await dealToPlayer(aidx);
  await wait(100);

  // Split aces: one card each only
  if(hand.cards[0].r==='A'&&splitCard.r==='A'){
    await dealToPlayer(aidx+1);
    hands.forEach(h=>h.done=true);
    await dealerPlay(); return;
  }

  await dealToPlayer(aidx+1);
  // Re-render to fix structure after additions
  renderHands();
  setBtns('play'); refreshBtns();
}

async function nextHand() {
  aidx++;
  while(aidx<hands.length&&hands[aidx].done) aidx++;
  if(aidx>=hands.length){ await dealerPlay(); }
  else { renderHands(); setBtns('play'); refreshBtns(); }
}

function refreshBtns() {
  const h=hands[aidx]; if(!h) return;
  document.getElementById('btnDouble').disabled=!(h.cards.length===2&&h.bet<=bal);
  document.getElementById('btnSplit').disabled=!(h.cards.length===2&&h.cards[0].r===h.cards[1].r&&hands.length<4&&h.bet<=bal);
}

// â”€â”€ DEALER PLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dealerPlay() {
  phase='dealer'; setBtns('none');
  flipHole(); await wait(450);
  while(total(dealer)<17||isSoft17(dealer)){
    await wait(350); await hitDealer();
    if(total(dealer)>21){ sndBust(); break; }
  }
  await wait(250); resolve();
}

function flipHole() {
  const row=document.getElementById('dealerRow');
  const cards=row.querySelectorAll('.card');
  if(cards.length<2) return;
  const hole=cards[1], card=dealer[1];
  sndFlip();
  hole.className='card flp'+(REDS.has(card.s)?' red':' black');
  setTimeout(()=>{
    hole.innerHTML=`
      <div class="cc top"><div class="cr">${card.r}</div><div class="cs">${card.s}</div></div>
      <div class="ccs">${card.s}</div>
      <div class="cc bot"><div class="cr">${card.r}</div><div class="cs">${card.s}</div></div>`;
  },150);
  setTimeout(()=>{ hole.classList.remove('flp'); setDealerScore(false); },350);
}

// â”€â”€ RESOLVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resolve() {
  phase='done';
  const dt=total(dealer), dBust=dt>21;
  let pnl=0, wins=0, losses=0, pushes=0;
  for(const h of hands){
    const pt=total(h.cards);
    if(pt>21){ losses++; pnl-=h.bet; }
    else if(dBust||pt>dt){ bal+=h.bet*2; wins++; pnl+=h.bet; }
    else if(pt===dt){ bal+=h.bet; pushes++; }
    else { losses++; pnl-=h.bet; }
  }
  updateBal(); renderDealer(false); renderHands();
  let txt,type;
  if(wins>0&&losses===0){ txt=wins>1?'ALL WIN!':'YOU WIN!'; type='win'; sndWin(); }
  else if(losses>0&&wins===0&&pushes===0){ txt='YOU LOSE'; type='lose'; }
  else if(pushes===hands.length){ txt='PUSH'; type='push'; }
  else { txt=wins>0?'PARTIAL WIN':'YOU LOSE'; type=wins>0?'win':'lose'; if(wins>0)sndWin(); }
  showResult(txt,type);
  const pay=document.getElementById('payoutText');
  pay.textContent=(pnl>=0?'+':'')+pnl.toLocaleString()+' PB';
  pay.className='payout-text show'+(pnl>0?' plus':pnl<0?' minus':'');
  sH++; sPnl+=pnl; if(wins>losses)sW++;
  addHist(wins>losses?'w':losses>wins?'l':'p',pnl);
  updateStats(); setBtns('bet');
  syncPB();
}

// â”€â”€ INSURANCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function takeIns(yes) {
  document.getElementById('insOverlay').classList.remove('show');
  if(yes){
    const cost=Math.floor(hands[0].bet/2);
    if(cost>bal){ toast('Not enough for insurance','lose'); }
    else { ins=cost; bal-=cost; updateBal(); sndChip(); }
  }
  if(ins>0&&isBJ(dealer)){ bal+=ins*3; updateBal(); toast(`Insurance pays +${(ins*2).toLocaleString()} PB`,'win'); }
  await afterDeal();
}

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult(txt,type){
  const el=document.getElementById('resultBanner');
  el.textContent=txt; el.className='result-banner show '+type;
}
function setBtns(mode){
  const ids=['btnDeal','btnHit','btnStand','btnDouble','btnSplit'];
  if(mode==='bet'){ ids.forEach((id,i)=>document.getElementById(id).disabled=i!==0); }
  else if(mode==='play'){ ids.forEach((id,i)=>document.getElementById(id).disabled=i===0); }
  else { ids.forEach(id=>document.getElementById(id).disabled=true); }
}
function updateBal() {
  userPB = bal;
  document.getElementById('pbDisplay').textContent = bal.toLocaleString() + ' PB';
}
async function syncPB() {
  if (currentUser) {
    await db.from('users').update({ pam_bucks: bal }).eq('id', currentUser.id);
    currentUser.pam_bucks = bal;
    // Hand fully resolved â€” clear the cheat-detection flag
    localStorage.removeItem('bj_pending_' + currentUser.id);
  }
}
function getBet(){ return Math.max(1,parseInt(document.getElementById('betInput').value)||100); }
function addToBet(n){ const i=document.getElementById('betInput'); i.value=Math.min(bal,(parseInt(i.value)||0)+n); }
function adjBet(f){ const i=document.getElementById('betInput'); i.value=Math.max(1,Math.min(bal,Math.round((parseInt(i.value)||100)*f))); }
function maxBet(){ document.getElementById('betInput').value=bal; }

function addHist(type,pnl){
  hist.unshift({type,pnl}); if(hist.length>30)hist.pop();
  const dots=document.getElementById('histDots'); dots.innerHTML='';
  hist.forEach(h=>{ const d=document.createElement('div'); d.className='h-dot '+h.type; d.textContent=h.type.toUpperCase(); d.title=(h.pnl>=0?'+':'')+h.pnl.toLocaleString()+' PB'; dots.appendChild(d); });
  const w=hist.filter(h=>h.type==='w').length;
  document.getElementById('histRate').textContent=`${w}/${hist.length} wins`;
}
function updateStats(){
  document.getElementById('stH').textContent=sH;
  document.getElementById('stW').textContent=sW;
  const el=document.getElementById('stP');
  el.textContent=(sPnl>=0?'+':'')+sPnl.toLocaleString();
  el.style.color=sPnl>0?'var(--success)':sPnl<0?'var(--error)':'var(--muted)';
}
let _tt;
function toast(msg,type){ const t=document.getElementById('toast'); t.textContent=msg; t.className='toast show '+type; clearTimeout(_tt); _tt=setTimeout(()=>t.className='toast',2200); }
const wait = ms => new Promise(r=>setTimeout(r,ms));

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT') return;
  const k=e.key.toLowerCase();
  if((k==='d'||k==='enter')&&!document.getElementById('btnDeal').disabled) startHand();
  else if(k==='h'&&!document.getElementById('btnHit').disabled) doHit();
  else if(k==='s'&&!document.getElementById('btnStand').disabled) doStand();
  else if(k==='x'&&!document.getElementById('btnDouble').disabled) doDouble();
  else if(k==='p'&&!document.getElementById('btnSplit').disabled) doSplit();
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  buildShoe();
  setBtns('none');
  document.getElementById('pbDisplay').textContent = 'â€”';

  const saved = localStorage.getItem('vault_session');
  if (!saved) {
    document.getElementById('loginPrompt').classList.add('show');
    return;
  }

  const { username } = JSON.parse(saved);
  const { data, error } = await db.from('users').select('*').eq('username', username).single();
  if (error || !data) {
    document.getElementById('loginPrompt').classList.add('show');
    return;
  }

  if (data.status === 'terminated') {
    const box = document.getElementById('loginPrompt');
    box.classList.add('show');
    box.querySelector('h2').textContent = 'Account Terminated';
    box.querySelector('p').textContent = 'Your account cannot access Blackjack.';
    box.querySelector('a').style.display = 'none';
    return;
  }

  currentUser = data;

  // Cheat detection: if a hand was in progress when they reloaded, the pending key
  // holds the already-deducted balance. Force that value and re-sync to Supabase
  // (in case the async update hadn't committed before the reload).
  const pendingKey = 'bj_pending_' + data.id;
  const pendingBal = localStorage.getItem(pendingKey);
  if (pendingBal !== null) {
    bal = parseInt(pendingBal);
    localStorage.removeItem(pendingKey);
    // Re-save in case the earlier fire-and-forget didn't land
    await db.from('users').update({ pam_bucks: bal }).eq('id', currentUser.id);
    data.pam_bucks = bal;
    showToastCheat();
  } else {
    bal = data.pam_bucks ?? 10000;
  }

  userPB = bal;
  updateBal();
  setBtns('bet');
}

function showToastCheat() {
  const banner = document.getElementById('resultBanner');
  const payout = document.getElementById('payoutText');
  if (banner && payout) {
    banner.className = 'result-banner lose show';
    payout.className = 'payout-text lose show';
    payout.textContent = 'Bet forfeited';
    setTimeout(() => {
      banner.className = 'result-banner';
      payout.className = 'payout-text';
    }, 4000);
  }
}

init();
</script>
</body>
</html>